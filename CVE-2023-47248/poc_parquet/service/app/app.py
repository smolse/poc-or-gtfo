from fastapi import FastAPI
import pyarrow.dataset as ds
import s3fs

app = FastAPI()


@app.get("/")
def trigger_pyarrow_vuln():
    minio_url = "http://minio:9000"
    access_key = "minio"
    secret_key = "minio123"
    bucket_name = "compromised-bucket"

    fs = s3fs.S3FileSystem(
        key=access_key,
        secret=secret_key,
        client_kwargs={"endpoint_url": minio_url},
        use_listings_cache=False
    )

    dataset = ds.dataset(f"{bucket_name}", filesystem=fs, format="parquet")
    table = dataset.to_table()

    return table.to_pydict()
